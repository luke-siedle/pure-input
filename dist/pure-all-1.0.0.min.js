(function(d,e){d.Class.Store=Class.extend({init:function(a){this.store=[];a&&this.add(a)},remove:function(a){var b=this;this.each(function(c,f){if(f==a)return b.store.splice(c,1),b.length--,!1})},reset:function(a){a||(this.store=[]);this.store=a},add:function(a,b){if(a instanceof d.Class.Store.Unit){if(this.find(a))return!1;this.length++;this.store.push(a)}else{if(a.length&&0<a.length){var c=new d.Class.Store,f;for(f in a){var e=this.add(a[f],!0);e&&c.add(e)}return c}if(this.exists(a))return!1;a=
new d.Class.Store.Unit(a);if(b)return this.length++,this.store.push(a),a}if(!b)return c=new d.Class.Store,c.add(a,!0),c},get:function(){var a=[];this.each(function(b,c){a.push(c.get())});return a},search:function(a,b,c){var f=[],e=0;this.each(function(g,h){var j=b(h.get());RegExp(d.cleanRegex(a.toLowerCase()),"i").test(j.value)&&(f.push(h),e++);if(e>=c)return!1});return new d.Class.Store(f)},find:function(a){var b=!1;this.each(function(c,f){if(f==a)return b=c,!1});return b},exists:function(a){var b=
!1,c=this.uniqueKey;this.each(function(f,d){if(d.get()[c]==a[c])return b=!0,!1});return b},each:function(a){e.each(this.store,function(b,c){return a(b,c)})},uniqueKey:"id",length:0,setTitle:function(a){this.title=a},unit:function(a){return this.store[a]}});d.Class.Store.Unit=Class.extend({init:function(a){this.unit=a},get:function(){return this.unit}});d.Globals.Storage={}})(PureUI,jQuery);(function(d,e){d.Class.Field=d.Class.Base.extend({init:function(a){this._super(a,function(){this.addRegister("asset",function(a){this.registered.asset.push({name:a[0],fn:a[1]})},function(){return!1})})},compile:function(){var a={},b;for(b in this.registered.asset){var c=this.registered.asset[b];a[c.name]=c.fn.call(this)}return a},register:function(a,b){var c={};c[a]=b;this.registrations.push(c)},validate:function(){},defaults:function(){return{classNames:this.el.attr("class"),plugins:{}}}});d.Class.Field.View=
d.Class.Base.View.extend({construct:function(){this.el.hide();this.renderElements();this.applyStyles()},renderElements:function(){var a=this.elements;this.el.after(a.superWrapper);a.superWrapper.append(a.mainWrapper)},createElements:function(){return{superWrapper:e("<div />"),mainWrapper:e("<div />"),inputWrapper:e("<div />")}}})})(PureUI,jQuery);(function(d,e){PureUI.Class.Input=PureUI.Class.Field.extend({__name:"input",construct:function(){this.store=new PureUI.Class.Store;this.register.asset(this.view.el.attr("name")||this.opts.fieldName||"value",function(){return this.getValue()});this.register.asset("tags",function(){return this.store.get()});this.attr("readonly","readonly"==this.view.el.attr("readonly"))},preConstruct:function(){this.value=this.opts.value||this.opts.el.val()||"";""!=this.value&&this.setValue(this.value,!0,!0)},getValue:function(){return this.value},
view:PureUI.Class.Field.View.extend({construct:function(){this._super();this.initialEl();this.renderElements();this.applyStyles();this.setup();var a=this;this.elements.traceInput.width(this.model.opts.minWidth);setTimeout(function(){a.setTraceInput()},1)},destroy:function(){this.el.show()},initialEl:function(){this.initial={height:this.el.height(),width:this.el.width(),fontSize:this.el.css("fontSize"),_padding:this.el.padding(),_margin:this.el.margin()}},renderElements:function(){this._super();var a=
this.elements,b=e("body");a.mainWrapper.append(a.relativePoint);a.inputWrapper.appendTo(a.mainWrapper);a.inputWrapper.append(a.input);a.clearInput.insertAfter(a.input);a.traceInput.appendTo(b);a.traceTokens.appendTo(b);a.traceTokens.css(this.getStyles("traceInput"));this.wrappers=a.mainWrapper;a.hint.appendTo(a.relativePoint)},createElements:function(){return e.extend({},this._super(),{traceInput:e("<div />").text("_"),traceTokens:e("<div />"),list:e("<div />"),input:this.model.opts.autogrow?e("<textarea />"):
e("<input />"),placeHolder:e("<div />"),clearInput:e('<div style="clear:both" />'),inputText:e('<span style="float:left" class="__text" />'),hint:e("<span />"),relativePoint:e("<div />").css({height:0,width:0,position:"relative",zIndex:1})})},setTraceInput:function(){var a=this.elements.input,b=a.val(),c=this.elements.input.val().replace(/\n/g,"<br />");0==b.length?(this.setInputPadding(),this.toggleHint(!0),this.els.mainWrapper.scrollTop(0),this.model._.Tokenizer&&(0==this.model._.Tokenizer.tokens.length?
this.elements.traceInput.width(this.model.opts.minWidth):this.toggleHint(!1))):(this.toggleHint(!1),this.els.traceInput.css("width","auto"));this.model.opts.autogrow?(this.elements.traceInput.html(c+"__"),this.setInput()):a.width(this.model.opts.maxWidth)},setInput:function(){var a=this.model.opts,b=this.elements,c=a.maxWidth,d=a.minWidth,i=a.maxHeight,g=a.minHeight,h=b.traceInput.outerWidth(),j=b.traceInput.height(),k=h>=d,m=h<=c,n=j>=g,o=j<=i,q=this.model._.Tokenizer;k&&m&&(b.input.width(h),b.inputWrapper.width(c));
n&&o&&(b.input.height(j),b.mainWrapper.height(j),this.toggleScroller(!1));k||(b.input.width(d),b.inputWrapper.width(d));m||(b.input.width(c),b.mainWrapper.width(c));n||(b.input.height(g),b.mainWrapper.css("height",g),b.inputWrapper.css("height",g),this.toggleScroller(!1));o||(b.input.height(j),b.mainWrapper.height(i),this.toggleScroller(!0));if(q&&(b.inputWrapper.width(c),d=this.model._.Tokenizer,j=d.tokens,0==j.length&&(d.view.els.inputFloatWrapper.height(a.height),b.mainWrapper.css("height",this.el.height())),
0<j.length)){var l=0,r=1,p=c-b.input.width(),a=j[0].view.els.content.outerHeight(),k=0,b=j[0];e.each(j,function(a,b){l=l+b.view.width;if(l>p){l=l-p;r++}});h<c?(this.els.input.width(h),j=!1):(this.els.input.width(c),j=!0);this.els.input.width()>c-l&&(j=!0);k=this.els.traceTokens.height()<2*this.model.opts.height?20:this.els.traceTokens.height();k>i?(this.wrappers.height(i),this.toggleScroller(!0)):(k<g&&(k=g),this.wrappers.height(k),this.toggleScroller(!1));c=this.els.traceTokens.height();j&&(c+=this.els.input.height());
c<g&&(c=g);0==this.els.input.parent().next().next(".__token").length?this.scrolling&&this.els.mainWrapper.scrollTop(c):0==this.els.input.parent().prev(".__token").length&&this.scrolling&&this.els.mainWrapper.scrollTop(0);g=b.view.el.margin();c=b.view.el.border();i=d.view.els.inputFloatWrapper;i.height(a+g.top+g.bottom+c.top+c.bottom);i.width(h)}},toggleScroller:function(a){var b=this.elements,c=this.model.opts.maxWidth,d=this.model._.Tokenizer;if(a){var e={cursor:"default",overflowY:"scroll",overflowX:"hidden"};
b.traceTokens.width(c-20);b.inputWrapper.width(c-20);d||b.input.width(c-20)}else e={cursor:"text",overflowY:"hidden",overflowX:"hidden"},b.traceInput.css("width","auto"),b.traceTokens.width(c);b.mainWrapper.css(e);this.scrolling=a},setup:function(){this.els.traceInput.addClass(this.model.opts.classNames);this.els.mainWrapper.addClass(this.model.opts.classNames);this.setInputPadding();this.model.opts.hint&&this.setHint()},setHint:function(){this.els.hint.css("line-height",this.initial.fontSize+"px");
this.els.hint.width(this.model.opts.maxWidth);this.els.hint.html(this.model.opts.hint)},setInputPadding:function(){var a=this.els,b=d.pxToInt(a.input.css("fontSize")),b=Math.floor(this.model.opts.height%b/3);a.input.css("padding",0);a.input.css("paddingTop",b)},styles:{input:{border:"none",padding:0,"float":"left",outline:"none",resize:"none",overflow:"hidden",margin:0,fontSize:function(a){return a.css("fontSize")},lineHeight:function(){return"normal"}},traceInput:{position:"absolute",top:-1E3,left:-1E3,
maxWidth:function(a,b){return b.model.opts.maxWidth},zIndex:1,background:"#fff",height:"auto"},inputWrapper:{width:function(a,b){return b.model.opts.minWidth}},mainWrapper:{height:function(a,b){return b.el.height()},width:function(a,b){return b.model.opts.maxWidth},cursor:"text"},hint:{position:"absolute",top:0,left:0,color:"#999",lineHeight:function(){return this.model.opts.height+"px"}},superWrapper:{position:function(a,b){return b.el.css("position")},left:function(a,b){return b.el.css("left")},
right:function(a,b){return b.el.css("right")},top:function(a,b){return b.el.css("top")},bottom:function(a,b){return b.el.css("bottom")}}},toggleHint:function(a){a?this.els.hint.show():this.els.hint.hide()}}),events:function(){this.register.event(this.view.elements.mainWrapper,"click");this.register.event(this.view.elements.input,"keyup","key");this.register.event(this.view.elements.input,"keydown","key");this.register.event(this.view.elements.input,"keypress","key");this.register.event(this.view.elements.input,
"focus");this.register.event(this.view.elements.input,"blur");this.register.event(this.view.elements.input,"mousedown");this.register.event("change")},subscribe:{Autocomplete:{listItemSelect:function(a,b,c,d){b=d.store.get()[0];c=a._.Mentioner;b&&(a._.NavList.view.setPosition(),c&&a.usingMention?this.setValue(c.applyMentions(this.value,b.name,b),!0):this._.Tokenizer?(this.setValue("",!0),a=this._.Tokenizer,a.addToken(d.store)?(a.singleSelect?(this._.Autocomplete._.NavList.clear(),this.suspend()):
this.view.els.input.focus(),0<a.tokens.length&&this.view.toggleHint()):this._.Autocomplete.showState("token_limit_reached")):this.setValue(b.name,!0))}},Tokenizer:{addToken:function(a){this.view.els.traceTokens.html(a.view.el.clone());this.view.setInput();a.singleSelect&&this.view.els.mainWrapper.addClass(d.prefix+"-token-select")},removeToken:function(a,b){b.finder&&b.finder.remove();this.view.els.traceTokens.html(a.view.el.clone());this.view.setInput();a.singleSelect&&(this.suspend(!0),this.view.els.mainWrapper.removeClass(d.prefix+
"-token-select"),this.view.toggleHint(!0));0==a.tokens.length&&this.view.toggleHint(!0)}}},on:{click:function(a){this._.Tokenizer?e(a.target).hasClass("__finder")||e(a.target).is(this.view.els.input)?this.view.elements.input.focus():(0<this._.Tokenizer.tokens.length&&this._.Tokenizer.inputToEnd(),this.view.elements.input.focus(),this.view.els.input.val("").val(this.value)):this.view.elements.input.focus()},key:function(a){var b=a.which,c=this;if("keypress"==a.type&&13==b)a.preventDefault();else if("keydown"==
a.type){if(40==b)return!0;if(this.attr("readonly")&&(!d.isNav(a.which)||8==a.which))return a.preventDefault(),!1;if(this.opts.maxLength&&(!d.isNav(a.which)&&8!=a.which)&&this.view.els.input.val().length+1>this.opts.maxLength)return a.preventDefault(),this.timeout(function(){this.setValue()},1),!1;setTimeout(function(){c.setValue();c.view.setTraceInput(b)},1)}},focus:function(){this.view.els.hint.addClass("active");if(!this.focused&&this.value)return this.timeout(function(){this.view.els.input.val("").val(this.getValue())},
1),!0;this.focused=!0},blur:function(){this.view.els.hint.removeClass("active");if(this._.Tokenizer){var a=this._.Tokenizer;a.inputToEnd();a.unselectToken();a.toggleInput()}this.focused=!1},mousedown:function(){this.focused=!0},change:function(){}},setValue:function(a,b,c){!a&&""!=a&&(a=this.view.els.input.val());if(this.opts.maxLength&&a.length>this.opts.maxLength)return this.value=a.substr(0,this.opts.maxLength),this.view.els.input.val(this.value),!1;var d=this.value;this.value=a;b&&(this.view.els.input.val(a),
this.view.setTraceInput());a!=d&&!c&&this.callEvent("change")},setHint:function(a){this.opts.hint=a;this.view.setHint()},suspend:function(a){this.suspended=void 0==a;a?this.view.els.input.attr("disabled",!1).show():this.view.els.input.attr("disabled",!0).hide()},onChangeAttribute:{disabled:function(){this.toggleState(this.attribute.disabled)}},toggleState:function(a){if(this.disabled=a){this.view.els.mainWrapper.add(this.view.els.input).addClass(d.prefix+"-disabled").attr("disabled",!0);var b=this.getPluginTree()}else this.view.els.mainWrapper.add(this.view.els.input).removeClass(d.prefix+
"-disabled").attr("disabled",!1);var b=this.getPluginTree(),c;for(c in b)b[c].disabled=a},plugins:{Autocomplete:function(){return d.Class.Autocomplete},Tokenizer:function(){return d.Class.Tokenizer},Validator:function(){return d.Class.Validator}},defaults:function(){return e.extend(!0,{},this._super(),{minWidth:10,maxWidth:this.el.width(),minHeight:this.el.height(),maxHeight:5E3,height:d.pxToInt(this.el.css("font-size"))||20,autogrow:!0,maxLength:this.el.attr("maxlength")||null,height:20,hint:this.el.attr("title")})},
methods:function(){return e.extend(!0,{},this._super(),{val:function(a){if(a){this.setValue(a,true);this.view.setTraceInput();a==""?this.view.toggleHint(true):this.view.toggleHint()}else return this.getValue()},focus:function(a){if(a){var b=this.publicInterface;this.view.els.input.focus(function(c){a.call(b,c)})}else this.view.els.input.focus()},setHint:function(a){this.setHint(a)}})},listeners:{change:function(){return[this.getValue()]}}})})(PureUI,jQuery);(function(d,e){d.Class.Autocomplete=d.Class.Base.extend({__name:"autocomplete",construct:function(){this.store=this.opts.storage?this.opts.storage:new d.Class.Store;this.mapSrc=this.opts.mapSrc||function(a){return{id:a.id,value:a.title}};this.opts.mapResults?this.createMultiStore():d.Globals.Storage[Math.random()]=this.store;"object"==typeof this.opts.src&&this.addSources(this.opts.src);this.value=this._parent.getValue()},view:d.Class.Base.View.extend({construct:function(){this.renderElements();this.el.width(this._parent.view.els.mainWrapper.outerWidth()-
2);this.els.input=this._parent.view.els.input},createElements:function(){return{el:e("<div />").css({position:"relative"})}},renderElements:function(){this.el.appendTo(this.model.opts._parent.view.els.superWrapper)},appendResults:function(a,b,c){var f=this,i,g=this.model.resultCount;b||(b=0);a.each(function(a,g){if(f.model.resultCount>f.model.maxResults)return!1;var h=g.get(),h=e.extend(!0,{},h,f.model.opts.mapSrc(h)),h=f.embold(d.replace(f.model.opts.templates.result,h),d.cleanRegex(f.model.lastKeyword),
h.value),h=f.model._.NavList.addItem({tpl:h,data:g},c);0==a&&0==b&&(i=h);f.model.resultCount++});this.refineListDisplay();i&&0==g&&f.model._.NavList.navigateTo(i.getPosition());if(0<g&&(a=f.model._.NavList.items,!f.model._.NavList.selectedItem))for(var h in a)if(!a[h].noSelect){f.model._.NavList.navigateTo(a[h].getPosition());break}},insertResults:function(a,b,c){this.appendResults(a,b,c)},appendResultSet:function(a,b,c){if(0<b.length)if(a.set)this.insertResults(b,c,a.set.placeholder);else{var f=
this.model._.NavList.addItem({tpl:d.replace(this.model.opts.templates.category,{value:a.title}),className:"__ignore"});f.noSelect=!0;f.view.el.addClass("pureui-title");this.appendResults(b,c);b=this.model._.NavList.addItem({tpl:"",className:"__ignore",noSelect:!0});b.noSelect=!0;b.view.el.hide();a.set={title:f,placeholder:b};return!0}},appendState:function(a){var b=this.model._.NavList.addItem({tpl:this.model.opts.templates.state[a],data:{state:a},noSelect:!0});b.noSelect=!0;this.model.stateItem=
b;b.view.el.addClass("pureui-state-"+a);this.refineListDisplay()},refineListDisplay:function(){var a=this.model._.NavList.view.el;this.model._.NavList.view.el.width(this.el.width()-(a.padding().left+a.padding().right))},clearResults:function(){this.model._.NavList.clear();if(this.model.multiStore)for(var a in this.model.multiStore)this.model.multiStore[a].set=null},embold:function(a,b){var c=RegExp(b,"gi");return a.replace(c,"<strong>"+a.match(c)[0]+"</strong>")}}),defaults:function(){return{}},events:function(){this.register.event(this._parent.view.els.input,
"keydown");this.register.event(this._parent.view.els.input,"keyup");this.register.event(this._parent.view.els.input,"keypress");this.register.event(this._parent.view.els.input,"focus");this.register.event(this._parent.view.els.input,"mousedown");this.register.event(this._parent.view.els.input,"blur");this.register.event(e(document),"mousedown","documentClick");this.register.event("listItemSelect");this.register.event("results");this.register.event("noResults")},subscribe:{NavList:{listItemSelect:function(a,
b){this.callEvent("listItemSelect",new d.Class.Arguments(arguments))},active:function(){var a=this._parent.view.els.superWrapper;"absolute"!=a.css("position")&&(a.css("z-index",20),a.css("position","relative"))},inactive:function(){var a=this._parent.view.els.superWrapper;"absolute"!=a.css("position")&&(a.css("z-index",0),a.css("position","static"))}},Mentioner:{addMention:function(){}}},on:{blur:function(){this.clearSearches()},keydown:function(a){var b=a.which;this._.NavList.keydown=(new Date).getTime();
if(this.nav[a.which])return this.nav[a.which].call(this,a);(function(c){setTimeout(function(){c.on.keypressed.call(c,b,a)},1)})(this)},keyup:function(){this._.NavList.keyup=(new Date).getTime()},keypress:function(a){13==a.which&&this._.NavList.active&&this._.NavList.selectedItem&&this._.NavList.callEvent("listItemSelect",new d.Class.Arguments([a,this._.NavList.selectedItem]))},keypressed:function(a,b){if((8==b.which||46==b.which)&&0==this.value.length)this.showState("start"),this._parent._.Tokenizer&&
this._parent._.Tokenizer.selectedItem&&this.showState("tokenizer_delete");else{this.value=this.view.els.input.val();this.usingMention=!1;if(this._.Mentioner&&!this._parent._.Tokenizer){var c=this._.Mentioner.findMention();if(c){this.value=c.substr(1);this.usingMention=!0;if(0==this.value.length){this.showState("startMention");return}if(4<this.value.split(" ").length){this.hideState();return}}else{this.hideState();return}}2<this.value.length?this.doSearch(this.value):0==this.value.length&&this.showState("start");
if(""==this.value||null==this.value)this.view.clearResults(),this.showState("start")}},listItemSelect:function(){this.view.clearResults();this.searches={};this.preventSearch=1;this.value="";this.showState("start")},documentClick:function(a){if(this._.NavList&&this._.NavList.active){var a=e(a.target).parents(),b=!0,c=this._parent.view.els.superWrapper.get(0);a.each(function(){if(e(this).get(0)==c)return b=!1});b&&this._.NavList.clear()}},focus:function(){(""==this.value||null==this.value)&&this.showState("start")},
results:function(){},noResults:function(){}},showState:function(a){if(!this._parent.suspended)switch(a){case "start":if(this._.Mentioner)break;case "startMention":this.view.clearResults();this.view.appendState(a);this.state=a;break;case "searching":this.view.appendState(a);this.state=a;break;default:this.view.clearResults(),this.view.appendState(a),this.state=a}},hideState:function(a){this.stateItem&&!(a!=this.state&&null!=a)&&(this._.NavList.removeItem(this.stateItem),this.state=this.stateItem=null)},
doSearch:function(a){this.lastKeyword=a;a=this.localSearch();this.renderResults(a);this.resultCount=a.length;0<this.resultCount?this.callEvent("results",d.args(["sync",a])):this.callEvent("noResults",d.args(["sync"]));this.resultCount>=this.opts.minResults||(this.searchTimeout&&window.clearTimeout(this.searchTimeout),this.showState("searching"),this.searchTimeout=this.timeout(function(){this.preventSearch?(this.searches={},this.preventSearch=!1):this.remoteSearch()},this.opts.searchTimeout))},localSearch:function(){if(this.mapResults){var a=
[],b;for(b in this.mapResults){var c=this.multiStore[b],d=this.searchStore(c);0<d.length&&a.push({store:c,resultSet:d})}return a}return this.searchStore(this.store)},addSources:function(a){if(this.multiStore)for(var b in a)this.multiStore[b].add(a[b]);else this.store.add(this.opts.src)},getHistory:function(){if(this.multiStore){var a={},b;for(b in this.mapResults){var c=this.multiStore[b].get();a[this.multiStore[b].getTitle()]=c}return a}return this.store.get()},setHistory:function(a){this.clearHistory();
this.multiStore||this.store.add(a)},clearHistory:function(){this.store=new d.Class.Store;this.opts.mapResults&&this.createMultiStore()},remoteSearch:function(){this.currentSearch&&this.clearSearch(this.currentSearch);this.currentSearch=(new Date).getTime();this.searches[this.currentSearch]=!0;(function(a){var b=this;"function"==typeof this.opts.src?this.opts.src(this.lastKeyword,function(c){b.hideState("searching");b.addSearchResults(c,a)}):"object"==typeof this.opts.src?b.hideState("searching"):
e.ajax({url:this.opts.src,type:"POST",data:{keyword:this.lastKeyword},dataType:"json",success:function(c){b.hideState("searching");b.addSearchResults(c,a)}})}).call(this,this.currentSearch)},addSearchResults:function(a,b){if(this.searches[b])if(this.mapResults){var c=0,f;for(f in this.mapResults){var e=this.multiStore[f];if(a[f]){var g=this.searchStore(e.add(a[f]));this.view.appendResultSet(e,g,c)&&c++}}}else a=this.searchStore(this.store.add(a)),this.view.appendResults(a),0<a.length?this.callEvent("results",
d.args(["async",a])):this.callEvent("noResults",d.args(["async"]))},clearSearch:function(a){this.searches[a]=null},clearSearches:function(){this.searches={};this.searchTimeout&&window.clearTimeout(this.searchTimeout)},searchActive:function(a){return this.searches[a]},searchStore:function(a){return a.search(this.lastKeyword,this.mapSrc,this.opts.minResults)},createMultiStore:function(){this.mapResults=this.opts.mapResults;this.multiStore={};for(var a in this.mapResults)this.multiStore[a]=new d.Class.Store,
this.multiStore[a].setTitle(this.mapResults[a])},appendResults:function(a){this.view.appendResults(a)},renderResults:function(a){this.view.clearResults();!(a instanceof d.Class.Store)&&0<a.length?this.renderSets(a):0<a.length&&this.view.appendResults(a)},renderSets:function(a){var b=0,c;for(c in a)this.view.appendResultSet(a[c].store,a[c].resultSet,b),b++},nav:{35:function(){},36:function(){},37:function(){},38:function(a){this._.NavList.active&&(a.preventDefault(),this._.NavList.navigateUp())},39:function(){},
40:function(a){this._.NavList.active&&(a.preventDefault(),this._.NavList.navigateDown())},13:function(){},9:function(){this._.NavList.clear()},27:function(){this._.NavList.clear()}},defaults:function(){return{minResults:30,maxResults:30,src:function(a,b){b({})},searchToken:Math.random(),searchTimeout:500,plugins:{NavList:!0},templates:{state:{start:"Type to start searching...",startMention:"Select an item to mention...",searching:"Searching...",tokenizer_delete:"Press Backspace or Delete to remove",
token_limit_reached:"Selection limit reached. Delete items to continue."},result:"{value}",category:"{value}"}}},pluginDefaults:function(){return{NavList:{renderTo:this.view.el},Mentioner:{mChar:"@",limit:-1}}},searches:{},mentions:{},plugins:{NavList:function(){return d.Class.NavList},Mentioner:function(){return d.Class.Mentioner}},listeners:{listItemSelect:function(a,b,c){return[c.store.get()[0]]},results:function(a,b){return[a,b.get()]},noResults:function(a){return[a]}},methods:function(){return e.extend(!0,
{},this._super(),{getHistory:function(){return[this.getHistory()]},setHistory:function(a){this.setHistory(a);return[]},clearHistory:function(){this.clearHistory();return[]}})}});d.Class.Mentioner=d.Class.Base.extend({construct:function(){this.input=this._parent.view.els.input},findMention:function(){this.value=this.input.val();var a=this.opts.mChar,b=RegExp(a,"gi"),c=RegExp(a+"[a-zA-Z0-9 ]+","gi"),d,e,g=this.value.match(RegExp(a,"gi")),g=g?g.length:0;if(g==this.getMentionData(this.value).length)return!1;
0<g&&(this.value=this.value.substr(this.value.lastIndexOf(a)));for(;!0==b.test(this.value);)e=!0,c.lastIndex=b.lastIndex,this.value.match(c)&&(d=this.value.match(c)[0]);!d&&e&&(d=this.opts.mChar);return this.lastMention=d},replaceMention:function(){return RegExp(this.lastMention.substr(1),"i")},existMention:function(a){a=d.cleanRegex(this.opts.mChar+a);return RegExp(a)},applyMentions:function(a,b,c){if(!this.existMention(b).test(a)){var a=a.split(this.opts.mChar),e=a[a.length-1],i=this.replaceMention();
a[a.length-1]=e.replace(i,b);a=a.join(this.opts.mChar);this.mentions[b]=c;this.callEvent("addMention",d.args([c]))}return a},getMentionData:function(a){var b=[],c;for(c in this.mentions)this.existMention(c).test(a)&&b.push(this.mentions[c]);return b},events:function(){this.register.event("addMention")},on:{addMention:function(){}},mentions:{},methods:function(){return e.extend(!0,{},this._super(),{getMentions:function(){return this.getMentionData(this.input.val())}})},listeners:{addMention:function(a){return[a]}}})})(PureUI,
jQuery);(function(d,e){d.Class.Validator=d.Class.Base.extend({construct:function(){},view:d.Class.Base.View.extend({createElements:function(){return{el:this._parent.view.els.input,wrapper:this._parent.view.els.mainWrapper}}}),events:function(){this.register.event(this.view.el,"keydown");this.register.event(this.view.el,"blur");this.register.event("validate");this.register.event("clear")},on:{keydown:function(){-1!=e.inArray("keypress",this.opts.events)&&(this.callEvent("clear"),this.timerecord&&clearTimeout(this.timerecord),
this.timerecord=this.timeout(function(){this.setValueAssets();this.doValidate()},this.opts.delay||1))},validate:function(a){this.view.els.wrapper.addClass(a?"valid":"invalid");a&&this.view.els.wrapper.removeClass("invalid")},clear:function(){this.view.els.wrapper.removeClass("valid invalid")},blur:function(){-1!=e.inArray("blur",this.opts.events)&&(this.setValueAssets(),this.doValidate())}},setValueAssets:function(){this.value=this._parent.getValue();this._parent._.Tokenizer&&(this.tokens=this._parent._.Tokenizer.getPublicInterface().getTokens())},
doValidate:function(){var a=this.opts,b=!0,c;if(""==this.value&&(!this.tokens||0==this.tokens.length))return this.callEvent("clear"),!1;if(a.filters)for(var e in a.filters){var i=(0,a.filters[e])(this.value,this.tokens);if(!1==i||!1==i.valid){b=!1;c=i.error||"Invalid";break}}this.valid=b;this.callEvent("validate",d.args([b,c]));return{valid:b,error:c}},defaults:function(){return{events:["keypress","blur"]}},methods:function(){return e.extend({},this._super(),{validate:function(){return this.doValidate()}})},
listeners:{validate:function(a,b){return[a,b]},clear:function(){return[]}}})})(PureUI,jQuery);(function(d,e){d.Class.NavList=d.Class.Base.extend({__name:"navlist",view:d.Class.Base.View.extend({construct:function(){this.model.items=[];this.model.count=0;this.el.hide();this.el.appendTo(this.model.opts.renderTo);this.setListDir();var a=this,b=function(){a.setListDir();a.setPosition()};e(window).resize(b).scroll(function(){a.scrollTimeout&&clearTimeout(a.scrollTimeout);a.scrollTimeout=setTimeout(function(){b()},50)})},populate:function(){var a=this.model;this.model.opts.store&&this.model.opts.store.each(function(b,
c){c.get();var e=new d.Class.NavList.Item({tpl:c.tpl});a.addItem(e)})},renderItem:function(a,b){b?a.view.el.insertBefore(b):this.el.append(a.view.el);this.addPosClasses();this.setHeight();this.setPosition()},addPosClasses:function(){this.el.children().removeClass("first last");this.el.children().not(".__ignore").first().addClass("first");this.el.children().not(".__ignore").last().addClass("last")},createElements:function(){return{el:e("<ul />").css({position:"absolute",top:0,left:0,zIndex:10})}},
setListDir:function(){var a=this.model.opts.renderTo,b=e(window).height(),a=a.offset().top,c=this.model.opts.maxHeight,d=e(window).scrollTop();this.model.renderUp=10>b+d-a-c;this.model.renderUp?this.el.addClass("up"):this.el.removeClass("up")},setPosition:function(){this.model.renderUp?this.el.css("top","-"+(this._parent._parent.view.els.superWrapper.height()+this.el.height()+this.el.padding().top+this.el.padding().bottom)+"px"):this.el.css("top",0)},setHeight:function(a){this.el.height()>=this.model.opts.maxHeight&&
!a?(this.el.css("overflowY","scroll"),this.el.height(this.model.opts.maxHeight)):(this.el.css("height","auto"),this.el.css("overflowY","hidden"))},styles:{el:{overflow:"hidden"}}}),addItem:function(a,b){var c=a;this.view.el.show();a instanceof d.Class.NavList.Item||(c=new d.Class.NavList.Item({tpl:a.tpl,store:new d.Class.Store(a.data),list:this,className:a.className}));this.items.push(c);this.view.renderItem(c,b?b.view.el:null);this.active=!0;this.callEvent("active");a.noSelect||this.count++;return c},
removeItem:function(a){a.view.el.remove();for(var b in this.items)if(a==this.items[b]){this.items.splice(b,1);a.noSelect||this.count--;break}0==this.items.length?this.clear():this.view.addPosClasses();this.view.setHeight(!0);this.view.setHeight();this.view.setPosition()},clear:function(){this.items=[];this.count=0;this.view.el.empty();this.view.el.hide();this.navPosition=0;this.active=!1;this.callEvent("inactive");this.view.setHeight(!0);this.view.setPosition();this.selectedItem=null},events:function(){this.register.event("active");
this.register.event("inactive");this.register.event("listItemSelect");this.register.event("listItemEnter");this.register.event("listItemLeave")},on:{listItemSelect:function(a,b){b.noSelect?this._parent._parent.view.els.input.focus():this.view.select()},listItemEnter:function(a,b){this.unselectAll();b.noSelect||b.view.select()},listItemLeave:function(a,b){b.view.unselect()},active:function(){},inactive:function(){}},unselectAll:function(){for(var a in this.items)this.items[a].view.unselect()},navigateUp:function(){this.active&&
0<this.navPosition&&(--this.navPosition,this.navigateTo(this.navPosition,"navigateUp"))},navigateDown:function(){this.active&&this.navPosition<this.items.length-1&&(++this.navPosition,this.navigateTo(this.navPosition,"navigateDown"))},navigateTo:function(a,b){if(this.active){this.navPosition=a;this.unselectAll();if(this.items[a]){if(this.items[a].noSelect){if(b&&1<this.items.length)this[b]();else this.navPosition++,this.navigateTo(this.navPosition);return}this.items[a].view.select()}var c=this.items[a];
c&&this.setScroller(c,a,b)}},setScroller:function(a,b,c){this.firstItem||(this.firstItem=1);var a=a.view.el.trueHeight(),d=Math.ceil(this.opts.maxHeight/a),e=d*a-this.opts.maxHeight,g=this.view.el.padding().top,b=b+1;b==this.items.length?(this.view.el.scrollTop(a*this.items.length),this.firstItem=this.items.length-d):"navigateUp"==c?b<=this.firstItem&&(1==b?this.view.el.scrollTop(0):this.view.el.scrollTop((b-1)*a-g/2),this.firstItem--):b<d||0==b?(this.view.el.scrollTop(0),this.firstItem=1):b>=this.firstItem+
d&&(this.view.el.scrollTop((b-d)*a+g+e),this.firstItem=b-d)},navPosition:0,defaults:function(){return{maxHeight:150,animateScroll:!0}},methods:function(){return e.extend(!0,{},this._super(),{getList:function(){var a=[],b;for(b in this.items)this.items.noSelect||a.push(this.items[b]);return a}})}});d.Class.NavList.Item=d.Class.Base.extend({__name:"navlist-item",construct:function(){this.store=this.opts.store;this.list=this.opts.list;this.opts.className&&this.view.el.addClass(this.opts.className)},
view:d.Class.Base.View.extend({construct:function(){this.el.append(this.model.opts.tpl)},createElements:function(){return{el:e("<li>")}},select:function(){this._super();this.model.noSelect&&this.model.list._parent._parent.view.els.input.focus();this.model.list.selectedItem=this.model}}),getPosition:function(){for(var a in this.list.items)if(this.list.items[a]==this)return a},events:function(){this.register.event(this.view.el,"click","select");this.register.event(this.view.el,"mouseenter","listItemEnter");
this.register.event(this.view.el,"mouseleave","listItemLeave")},on:{select:function(a){this.list.callEvent("listItemSelect",d.args([a,this]))},listItemEnter:function(a){this.list.callEvent("listItemEnter",d.args([a,this]))},listItemLeave:function(a){this.list.callEvent("listItemLeave",d.args([a,this]))}}})})(PureUI,jQuery);(function(d,e){d.Class.Tokenizer=d.Class.Base.extend({__name:"tokenizer",init:function(a){this._super(a);this.tokens=[];this.singleSelect=1==this.opts.limit},view:d.Class.Base.View.extend({construct:function(){var a=this.model._parent;a&&(a=a.view.els.input,this.el.insertBefore(a),this.els.inputFloatWrapper.appendTo(this.el),a.appendTo(this.els.inputFloatWrapper),this.placeHolder=this.els.inputFloatWrapper)},destroy:function(){var a=this.model._parent;a.view.els.input.insertBefore(a.view.els.clearInput)},
createElements:function(){return{el:e("<div />").css({"float":"left"}),inputFloatWrapper:e("<div />").css({"float":"left"})}}}),addToken:function(a){if(this.opts.limit&&this.tokens.length>=this.opts.limit)return!1;a=new d.Class.Tokenizer.Token({store:a,tokenizer:this});this.tokens.push(a);this.singleSelect=1==this.opts.limit;this._parent._.Validator&&this._parent._.Validator.setValueAssets();this.callEvent("addToken",d.args([a]));this.singleSelect&&this.doSingleSelect(a);return a},clearTokens:function(){for(var a in this.tokens)this.removeToken(this.tokens[a])},
removeToken:function(a){var b=this.tokens,c=this;this.removedToken=a;e.each(this.tokens,function(d,e){if(a==e)return b.splice(d,1),e.view.el.remove(),c.lastRemoved=a,!1});this.tokens=b;this.callEvent("removeToken",d.args([this.lastRemoved]))},doSingleSelect:function(a){a&&(a.singleSelect(),this._parent.suspend(),this._parent._.NavList&&this._parent._.NavList.clear())},on:{addToken:function(){},key:function(a){"keyup"!=a.type&&(this.nav[a.which]&&!this.singleSelect)&&this.nav[a.which].call(this,a,
a.type)},removeToken:function(){this._parent.view.els.input.focus()},clickToken:function(){}},events:function(){this.register.event(this._parent.view.els.input,"keydown","key");this.register.event(this._parent.view.els.input,"keyup","key");this.register.event("removeToken");this.register.event("addToken");this.register.event("clickToken")},tokenFromEl:function(a){return a.data("PureUI.Tokenizer.Token")},navigateTo:function(a){var b=this.selectedItem;b&&this.unselectToken(b);this.selectToken(a)},navigateLeft:function(a){var b=
this._parent.getValue(),c=this._parent.view.els.input,d=c.parent().prev(".__token").first(),d=a?a.view.el.prev(".__token").first():d;0==this.tokens.length||""!=b||(0==d.length?(this.unselectToken(),this.toggleInput(),this.timeout(function(){this.inputToStart();this.timeout(function(){c.focus()},10)},10)):(a=this.tokenFromEl(d),a==this.selectedItem||a&&a.attr("readonly")?a!=this.selectedItem&&this.selectedItem?(this.unselectToken(),this.toggleInput()):(this.unselectToken(),this.toggleInput(),this.timeout(function(){c.parent().insertBefore(d);
this.timeout(function(){c.focus()},10)},10)):this.selectedItem||this.inputHidden?(this.unselectToken(),this.toggleInput()):this.selectToken(a)))},navigateRight:function(a){var b=this._parent.getValue(),c=this._parent.view.els.input,d=c.parent().next(".__token").first(),d=a?a.view.el.next(".__token").first():d;0==this.tokens.length||""!=b||(0==d.length?(this.inputToEnd(),this.unselectToken(),this.toggleInput(),this.timeout(function(){c.focus()},10)):(a=this.tokenFromEl(d),a==this.selectedItem||a&&
a.attr("readonly")?(a!=this.selectedItem&&this.selectedItem||(c.parent().insertAfter(d),this.timeout(function(){c.focus()},10)),this.unselectToken(),this.toggleInput()):this.selectedItem||this.inputHidden?(this.unselectToken(),this.toggleInput()):this.selectToken(a)))},navigateRemove:function(){var a=this.selectedItem;this.unselectToken(a);this.toggleInput();this.removeToken(a)},nav:{8:function(){this.selectedItem?this.navigateRemove():this.navigateLeft()},37:function(){this.navigateLeft()},38:function(){var a=
this._parent.view.els.input;""==a.val()&&this.timeout(function(){this.inputToStart();this.timeout(function(){a.focus()},10)},10)},39:function(){this.navigateRight()},40:function(){var a=this._parent.view.els.input;""==a.val()&&this.timeout(function(){this.inputToEnd();this.timeout(function(){a.focus()},10)},10)},46:function(){this.selectedItem?this.navigateRemove():this.navigateRight()},36:function(a){this.nav[38].call(this,a)},35:function(a){this.nav[40].call(this,a)}},inputToStart:function(){if(0<
this.tokens.length){var a=this.view.el.children(".__token").first(),a=a.data("PureUI.Tokenizer.Token");this.view.els.inputFloatWrapper.insertBefore(a.view.el)}},inputToEnd:function(){if(0<this.tokens.length){var a=this.view.el.children(".__token").last(),a=a.data("PureUI.Tokenizer.Token");this.view.els.inputFloatWrapper.insertAfter(a.view.el)}},selectToken:function(a){this.selectedItem&&this.selectedItem.view.el.removeClass("selected __selected");a.view.el.addClass("selected __selected");this.selectedItem=
a;this.toggleInput(1);this._parent._.Autocomplete&&this._parent._.Autocomplete.showState("tokenizer_delete")},unselectToken:function(a){if(!a&&(a=this.selectedItem,!a))return;a.view.el.removeClass("selected __selected");this.selectedItem=null;this._parent._.Autocomplete&&this._parent._.Autocomplete.showState("start")},toggleInput:function(a){var b;a?(this.inputCss={position:this.view.els.inputFloatWrapper.css("position"),width:this.view.els.inputFloatWrapper.width(),top:"auto",left:"auto"},b={position:"absolute",
width:0,left:-1E3}):b=this.inputCss;b&&this.view.els.inputFloatWrapper.css(b);this.inputHidden=a},methods:function(){return e.extend(!0,{},this._super(),{getTokens:function(){var a=[];e.each(this.tokens,function(b,c){a.push(c.getPublicInterface())});return a},setTokens:function(a){this.clearTokens();for(var b in a)this.addToken(new d.Class.Store([a[b]]))},clearTokens:function(){this.clearTokens()},getTokenData:function(){var a=[];e.each(this.tokens,function(b,c){a.push(c.store.get()[0])});return a}})},
listeners:{addToken:function(a){return[a.store.get()[0],a.getPublicInterface()]},removeToken:function(a){return[a.store.get()[0]]},clickToken:function(a,b){return[b.store.get()[0],b.getPublicInterface()]}}});d.Class.Tokenizer.Token=d.Class.Base.extend({__name:"tokenizer-token",construct:function(){this.view.el.data("PureUI.Tokenizer.Token",this);this.store=this.opts.store},view:d.Class.Base.View.extend({construct:function(){var a=this.model.opts.store.get()[0];this.el.append(this.els.finder.add(this.els.content).add(this.els.deleter));
this.els.content.text(d.replace(this.model.opts.template,a));this.model.opts.tokenizer.view.placeHolder&&this.el.insertBefore(this.model.opts.tokenizer.view.placeHolder);this.applyStyles();this.setWidth();this.els.finder.height(this.el.height())},createElements:function(){return{el:e('<div class="__token" />'),finder:e('<span class="__finder" />'),content:e('<span class="__content" />'),deleter:e('<span class="__deleter" />').attr("title","Remove"),clear:e("<span />")}},setWidth:function(){var a=
this.el.clone(),b=a.find(".__content"),c=a.find(".__finder"),d=this.elements;a.appendTo(e("body"));d.content.width(b.width()+2);this.el.height(b.outerHeight());this.el.css("line-height",this.el.css("fontSize")+"px");b=b.outerWidth()+c.width();this.el.width(b+2);this.width=b+2;a.remove()},styles:{el:{"float":"left",position:"relative"},finder:{"float":"left",cursor:"text",width:5},content:{cursor:"pointer","float":"left",width:"auto"},clear:{clear:"left"},deleter:{cursor:"default","float":"right"}}}),
defaults:function(){return{template:"{name}"}},events:function(){this.register.event(this.view.els.finder,"click","finderClick");this.register.event(this.view.els.deleter,"click","deleterClick");this.register.event(this.view.el,"click")},on:{finderClick:function(){this.opts.tokenizer.view.placeHolder.insertBefore(this.view.el)},deleterClick:function(){this.opts.tokenizer.removeToken(this);this.opts.tokenizer.doSingleSelect(!1)},click:function(a){a.target!=this.view.els.deleter.get(0)&&a.target!=this.view.els.finder.get(0)&&
this.opts.tokenizer.callEvent("clickToken",d.args([a,this]))}},singleSelect:function(){this.view.el.addClass(d.prefix+"-single-select");var a=this.opts.tokenizer._parent.view.els.inputWrapper.width();this.opts.tokenizer.view.el.width(a);this.view.el.width(a);this.view.els.deleter.css("float","right")},onChangeAttribute:{readonly:function(){this.attribute.readonly?this.view.els.deleter.hide():this.view.els.deleter.show()}},methods:function(){return e.extend(!0,{},this._super(),{data:function(a){if(a)this.store=
new d.Class.Store(a);else return this.store.get()[0]},remove:function(){this.options.tokenizer.removeToken(this)}})}})})(PureUI,jQuery);
